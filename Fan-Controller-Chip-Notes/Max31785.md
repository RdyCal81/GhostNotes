# ReadMe
[GitLab issue 415](https://gitlab.canoga.com/engineering/embedded/tsx/-/issues/415)
# Usage
```
No logging has been enabled.

The following percentages are from one of 4 possible tables.  This is the one I chose.

Fan health is defined as
Green  RPM is within +-10% at given PWM
Orange RPM is within +-15% at given PWM
Red    RPM is over   +-15% at given PWM

Yellow  is defined as an unstable motor.


Voltages 0-1 are used.  2-5 are not used.
0: 3.3v  UCD_3V3
	Warnings at +- 5%
	Faults at +- 10%
1: 0.75V SYS_1V5_mSATA
	Warnings at +- 5%
	Faults at +- 10%

Temperatures
6 Temperature Diodes are not used.
1 Internal temperature is used.
2 External DS75 chips are used.
  The internal and both external sensors are 
  used to control all 4 fans.
  All 3 temperature sensors control all 4 fans 
  and act the same.
Over temperature warnings are set at 60°C
Over temperature warnings are set at 70°C

Fans 0-3 are used.  4-5 are not used.
All 4 fans are configured the same.
Speeds are determined by the hottest of the 3
temperature sensors.
Controlled by RPM.  Not PWM
PWM frequency is 25kHz.  150hz is too slow.
2°C Hysteresis, 4°, 6° or 8° was too much in my opinion
Update every 1000ms, 2% per second.  every 200ms was too fast for the fans.  1% per second takes too long to achieve max speed. 
Ramp to 100% if there is a temperature sensor fault
Ramp to 100% if there is a fan fault.
1000 RPM or less is a Fan Warning
500 RPM or less is a Fan Fault.

Fan health is enabled.
Fans were run at the following percentages, the RPM noted and added to the PWM table.  
Values were derived from running the PWM, not calculated.
40%		3,950
60%		6,300
80%		8,500
100%		8,800

Fan speeds are determined by the hottest of the 3 temperature sensors.  
The following is the temperature to fan RPM table that I have created.
The fan speed will change the the temperature is rising and stable for 2 seconds.
When the temperature is falling, there is a 2°C Hysteresis, so it will change 2°C lower than the table entry.
25°C		2,000 RMP
31°C		3,000 RMP
36°C		4,000 RMP
42°C		5,000 RMP
48°C		6,000 RMP
53°C		7,000 RMP
59°C		8,000 RMP
65°C		9,000 RMP
```

# Evaluate
```
FAN_COMMAND_1
FAN_CONFIG_1_2
TACHSEL
	Should be = 0 as we don't want dual fan mode.
LUT  Look up table
MFR_FAN_LUT 

11 available temperature sensors
Temperature offset ??

```

```

```
## Datasheet

[max31785 Datasheet](/home/randy/sandbox/notes/Fan-Controller-Chip-Notes/max31785.pdf) MyFile


[DS75](/home/randy/sandbox/notes/Fan-Controller-Chip-Notes/DS75.pdf) MyFile

[Eval Board](/home/randy/sandbox/notes/Fan-Controller-Chip-Notes/MAX31785K.pdf) MyFile

[SyncMetra Fan](/home/randy/sandbox/notes/Fan-Controller-Chip-Notes/6735210-6_for_review.pdf) MyFile

[I2C HID](https://www.stg-maximintegrated.com/en/products/interface/controllers-expanders/DS3900P2EVKIT.html)

```

```

[Max GUI](https://www.analog.com/en/design-center/evaluation-hardware-and-software/software/software-download.html?swpart=SFW0009300A)

[Eval Board](https://www.analog.com/media/en/technical-documentation/data-sheets/MAX31785K.pdf) WebSite



[max31785 Datasheet](https://www.analog.com/media/en/technical-documentation/data-sheets/max31785.pdf) WebSite

[DS75](https://www.analog.com/media/en/technical-documentation/data-sheets/DS75.pdf)  WebSite

[Kernel driver max31785](https://www.kernel.org/doc/html/v5.7/hwmon/max31785.html)  Website

[Kernel driver max31785 .c file](https://git.everest.canoga.com/engineering/embedded/yocto/linux-canoga/-/blob/development/drivers/hwmon/pmbus/max31785.c) GitLab file


## Evaluate Fan controller chip.
Research the Max31785k fan controller chip, on the evaluation board,

### All of these tests are done using the evaluation board

These steps are completed using the GUI that comes with the eval board
1. Read internal temperature sensor, DS75 sensor mounted on eval board and one externally mounted DS75 sensor.
2. Configure and manually control fans 0 - 3.  Syncmetra utilized those 4 fans.
3. Configure an LUT, look up table, such that fans will automatically adjust depending on temperature.  
	1. Determine and configure which temperature sensor.  It will be either the Max31785k internal sensor, one of the two external DS75's. 
4. Configure an LUT, look up table, such that fans will automatically adjust depending on temperature.  
5. Reset the Max31785k and ensure the fans are default at 100% speed.

### These steps are completed by attaching the eval board's I2C bus to a TSX switch I2C bus.

1. Ensure driver has been loaded and the MFS shows all of the Max31785k register files.
2. Repeat all steps that were done using the GUI.


##### FAN_COMMAND_1
##### FAN_CONFIG_1_2
D0  1101 0000   1 = Bit 6


Configuration:
FAN_COMMAND_1  8000
FAN_CONFIG_1_2 D0
```
Page 5
;Fan Connected to PWM 5
;Command(name)		Command(hex)	#Bytes(dec)	Data(hex)[LSW/LSB...MSW/MSB]
FAN_COMMAND_1           	3B	2	8000	
MFR_FAN_CONFIG          	F1	2	E671	
FAN_CONFIG_1_2          	3A	1	D0	
MFR_FAN_FAULT_LIMIT     	F5	2	1F40	
MFR_FAN_LUT             	F2	32	03E8	03E8	07D0	07D0	0BB8	0BB8	0FA0	0FA0	1388	1388	1770	1770	1B58	1B58	1F40	1F40	
MFR_FAN_PWM2RPM         	F9	8	12E8	1A68	210C	251C	
MFR_FAN_WARN_LIMIT      	F6	2	2328	
MFR_FAULT_RESPONSE      	D9	1	02	



Page 5
;Fan Connected to PWM 5
;Command(name)		Command(hex)	#Bytes(dec)	Data(hex)[LSW/LSB...MSW/MSB]
FAN_COMMAND_1           	3B	2	0100	
MFR_FAN_CONFIG          	F1	2	E671	
FAN_CONFIG_1_2          	3A	1	90	
MFR_FAN_FAULT_LIMIT     	F5	2	1F40	
MFR_FAN_LUT             	F2	32	03E8	03E8	07D0	07D0	0BB8	0BB8	0FA0	0FA0	1388	1388	1770	1770	1B58	1B58	1F40	1F40	
MFR_FAN_PWM2RPM         	F9	8	12E8	1A68	210C	251C	
MFR_FAN_WARN_LIMIT      	F6	2	2328	
MFR_FAULT_RESPONSE      	D9	1	02	

```

### My fan Config 5
```
Page 5
;Fan Connected to PWM 5
;Command(name)		Command(hex)	#Bytes(dec)	Data(hex)[LSW/LSB...MSW/MSB]
FAN_COMMAND_1           	3B	2	0100	
	Because Bit 6 is 0
			0100 = a %Duty cycle.  
	
MFR_FAN_CONFIG          	F1	2	E671	
		15:13	111	25kHz frequency
		12
		11:10   01
		9
		8
		
FAN_CONFIG_1_2          	3A	1	90
		7:  1 Enable fans
		6:  0 PWM  (Not RPM)
		5:4 2 2 pulses per revolution.
MFR_FAN_FAULT_LIMIT     	F5	2	1F40	
MFR_FAN_LUT             	F2	32	03E8	03E8	07D0	07D0	0BB8	0BB8	0FA0	0FA0	1388	1388	1770	1770	1B58	1B58	1F40	1F40	
MFR_FAN_PWM2RPM         	F9	8	12E8	1A68	210C	251C	
MFR_FAN_WARN_LIMIT      	F6	2	2328	
MFR_FAULT_RESPONSE      	D9	1	02	
```


# SyncMetra
## Fabric Card
```
	DS75, Master I2C Bus, Addr 000b, Front edge of board
	DS75, Master I2C Bus, Addr 001b, Back edge of board
```

# Notes

## Final  Configuration
### MFR_MODE -Common Register
```
MFR_MODE          	D1	2	0007
		15		0	Do not log
		14		0	Set to clear log.
		13		0	Alert disabled.  
					 If set the host will need to intervene on alert
		12		0	Always 0
		11		0	Soft Reset. Set/Clear/Set within 8ms
		10:8		0	Always 0
		7:6		00	Define Health.  4 options. 
					Green  <10%
					Orange <15%
					Red    >15%
		5:0		000011	ADC 5-2 Disabled, ADC 1 - 0 Enabled
					Enabled is overridden if temp sense is enabled.
					  MFR_TEMP_SENSOR_CONFIG bit 15
```
### MFR_FAULT_RESPONSE - Fans, Temperatures & Volts
```
Temperatures
MFR_FAULT_RESPONSE	D9	1	02
		7		0	Do not log
		6		0	N/A for temperatures, only pages 17-22 (volts)
		5		0	N/A for temperatures, only pages 17-22 (volts)
		4:3		0	Always 0
		2		0	N/A for temperatures, only pages 17-22 (volts)
		1		1	Assert Fault pin during active fault
		0		0	N/A for temperatures, only pages 0-5 (fans)

Voltages
MFR_FAULT_RESPONSE	D9	1	06
		7		0	Do not log
		6		0	No OV log either
		5		0	Fault/Warning on 1 excursion.
		4:3		0	Always 0
		2		1	Enable fault on OV also.
		1		1	Assert Fault pin during active fault
		0		0	N/A for voltages, only pages 0-5 (fans)

Fans
MFR_FAULT_RESPONSE	D9	1	03
		7		0	Do not log
		6		0	N/A for fans, only pages 17-22 (volts)
		5		0	N/A for fans, only pages 17-22 (volts)
		4:3		0	Always 0
		2		0	N/A for fans, only pages 17-22 (volts)
		1		1	Assert Fault pin during active fault
		0		1	Force fans to 100% when Fault pin active
```
### Fans
```
FAN_COMMAND_1           	3B	2	8000		
		15		1	Automatic fan control
		14:0		0	RPM or PWM if not automatic.
		
MFR_FAN_CONFIG          	F1	2	E033	
		15:13	111	25kHz PWM Freq.
					150Hz and most likely lower caused the fan stop
					when accelerating to slow speeds.  (2,000 RMM).
					Most likely the Freq. interfered with the actual
					speed of the fan motor
		12		0	Disable Dual-tach
		11:10	00	2°C Hysteresis.  I decided 4°, 6° or 8° was too much.
					I want the fans on at 25° and as the temperature 
					drops I want them to come back on as close to 25° as
					possible, so this will turn them back on at 23°
		9		0	Ramp to 100% PWM if temp sensor faults.
		8		0	Ramp to 100% PWM if fan fault detected
		7:5		001	Update every 1000ms, 2% per second.
					Updating every 200ms was too fast for the fan, the 
					fans speed did not respond fast enough.
		4		1	Enable Health
		3		0	This is egnored because bit 2, is 0
		2		0	Tach input expects fan RPM.
		1:0		11	Detect 8 revolutions within 2 seconds at fan start.
					If not 8, then 100% PWM.
					
FAN_CONFIG_1_2          	3A	1	D0	
		7		1	Fan Enabled
		6		1	1 = RPM mode.
		5:4		01	Fan has 2 pulses per revolution.
		3:0		0	Always 0


MFR_FAN_FAULT_LIMIT     	F5	2	01F4
		15:0		01F4		500 RPM set a a Fan Fault.
						1000 RPM will be a Fan Warning
							
MFR_FAN_LUT              F2  32  09C4 07D0   0C1C 0BB8   0E10 0FA0   1068 1388   12C0 1770   14B4 1B58   170C   1F40   1964 2328
; Max 9,000 RPM                  25°  2,000  31°  3,000  36°  4,000  42°  5,000  48°  6,000   53° 7,000   59°    8,000  65°  9,000

MFR_FAN_PWM2RPM         	F9	8   0F6E  189C  2134  2260	
;								40%   60%   80%   100%
; 9,000 RPM                      3,950 6,300 8,500 8,800

MFR_FAN_WARN_LIMIT      	F6	2	03E8	
		15:0		03E8		1000 RPM set a a Fan Warning.
						500 RPM will be a Fan Fault

```
### Temperature
```
MFR_TEMP_SENSOR_CONFIG		800F
		15	1	Enabled
		14:10	0	No temp ° offset
		9:6	0	Always 0
		5	0	Not Fan 5
		4	0   Not Fan 4
		3	1   Used to control Fan 3 speed
		2	1   Used to control Fan 2 speed
		1	1   Used to control Fan 1 speed
		0	1   Used to control Fan 0 speed
		
OT_FAULT_LIMIT          	4F	2	1858
;                                70°
OT_WARN_LIMIT           	51	2	1170
;                                60°

```
### Voltages
```
R1 / (R1+R2) = Divisor
VOUT_SCALE_MONITOR / 32,767 = Divisor
:: VOUT_SCALE_MONITOR = Divisor * 32,767
Full scale input is 1.225v

; Voltage 0
; 4.99k / (10k + 4.99k) = 0.332888592
; 10,908 = 0.332888592 * 32,767
;
VOUT_OV_FAULT_LIMIT     	40	2	7FFF	
VOUT_OV_WARN_LIMIT      	42	2	7FFF	
VOUT_SCALE_MONITOR      	2A	2	2A9C	
VOUT_UV_FAULT_LIMIT     	44	2	0000	
VOUT_UV_WARN_LIMIT      	43	2	0000

; Voltage 1
; 10k / (10k + 10k) = 0.5
; 16,383 = 0.5 * 32,767
;
VOUT_OV_FAULT_LIMIT     	40	2	7FFF	
VOUT_OV_WARN_LIMIT      	42	2	7FFF	
VOUT_SCALE_MONITOR      	2A	2	28EC	
VOUT_UV_FAULT_LIMIT     	44	2	0000	
VOUT_UV_WARN_LIMIT      	43	2	0000
```




```


For each fan
MFR_FAN_CONFIG          	F1	2	6213
		15:13	011	150Hz frequency
		12	0 	Not DualTach
		11:10   00	2° Hysteresis
		9	0	Ramp to 100% on temp fault
		8	0	Ramp to 100% on fan fault
		7:5	000	1000, 1, 60
		4	1	Health meter enabled
		3	0	Ignored
		2	0	Tach expects RPM
		1:0	11	Eight revolutions
		


FAN_COMMAND_1 			8000
		8000		Ignore, use fan control

FAN_CONFIG_1_2			  D0
		7	1	Fan enabled
		6	1	RPM mode, (Not PWM)
		5:4	01	2 PPRev
		3:0		Always 0

MFR_FAN_LUT
MFR_FAN_CONFIG

MFR_FAN_WARN_LIMIT
MFR_FAN_FAULT_LIMIT

MFR_FAN_PWM2RPM



STATUS_FANS_1_2

MFR_TEMP_SENSOR_CONFIG  	F0	2	8020
		15		1	Sensor Enabled
		14:10	0 	No temp ° offset, 0°C offset
		9:6		0	Always 0
		5		1	Fan 5
		4		0
		3		0
		2		0
		1		0
		0		0
```

### José instructions
```
Remove 0Ω resistors for 3 voltage inputs.  RS+-0, 1 and 2
R001 & R002
R101 & R102
R201 & R202
Ground with wire RS-0, RS-1, RS-2.  R002, R102, R202
```





## Things2Do
- [ ] FAN_HEALTH_CRITERIA
- [ ] THERMAL HYSTERESIS (°C) set to 2°C
- [ ] TSFO & TACHO set to ramp fan to 100% if error
- [ ] HEALTH


# Manual speed, fan 5
```
MFR_MODE				Nothing for manual speed
MFR_FAULT_RESPONSE	03

MFR_FAN_CONFIG		A lot of stuff.
	HEALTH
MFR_FAN_LUT 			Not used for manual

FAN_CONFIG_1_2		90 
FAN_COMMAND_1		0000 to 2710 PWM

```

```
Fan 5
100%		10,000
 80%		 8,000
 60%		 6,000
 40%		 4,000
```


# Final configuration
## Syncmetra Fabric card configuration
### Fan configuration
```
Same configuration for all 4 fans.  
Fans being used are 0-3, 4-5 are not being used.
```

# Ordering question
```
Hello,
  My company will be ordering the MAX31785ETL+ part.  Is there an option to order these parts with pre-programmed?  We would like to install them with our program already in them
Thank you,
  Randy A. Callaway
  Sr. Software Engineer
```
```
	myAnalog  rcallaway@canogaperkins.net:rc8192[MAAO]@
	Thank you for submitting a support inquiry with Analog Devices.
CS-351689-T5K6Q9 has been created for the issue submitted by you.
```