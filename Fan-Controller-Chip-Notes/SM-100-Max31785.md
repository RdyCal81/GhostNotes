# SM-100 Max31785 Fan Controller Usage

* No logging has been enabled.

* The following percentages are from one of 4 possible tables.  This is the one I chose.

* Fan health is defined as
```
Green  RPM is within +-10% at given PWM
Orange RPM is within +-15% at given PWM
Red    RPM is over   +-15% at given PWM

Yellow  is defined as an unstable motor.
```



## Voltages 0-1 are used.  2-5 are not used.
```
0: 3.3v  UCD_3V3
	Warnings at +- 5%
	Faults at +- 10%
1: 0.75V SYS_1V5_mSATA
	Warnings at +- 5%
	Faults at +- 10%
```
	
## Temperatures
* 6 Temperature Diodes are not used.
* 1 Internal temperature is used.
* 2 External DS75 chips are used.
```
  The internal and both external sensors are 
  used to control all 4 fans.
  All 3 temperature sensors control all 4 fans 
  and act the same.
```
* Over temperature warnings are set at 60°C
* Over temperature warnings are set at 70°C

## Fans 0-3 are used.  4-5 are not used.
* All 4 fans are configured the same.
* Speeds are determined by the hottest of the 3 temperature sensors.
* Controlled by RPM.  Not PWM
* PWM frequency is 25kHz.  150hz is too slow.
* 2°C Hysteresis, 4°, 6° or 8° was too much in my opinion
* Update every 1000ms, 2% per second.  every 200ms was too fast for the fans.  1% per second takes too long to achieve max speed. 
* Ramp to 100% if there is a temperature sensor fault
* Ramp to 100% if there is a fan fault.
* 1000 RPM or less is a Fan Warning
* 500 RPM or less is a Fan Fault.
* Fan health is enabled.
* Fans were run at the following percentages, the RPM noted and added to the PWM table.  
	* Values were derived from running the PWM, not calculated.
```
40%		3,950
60%		6,300
80%		8,500
100%		8,800
```

* Fan speeds are determined by the hottest of the 3 temperature sensors.  
* The following is the temperature to fan RPM table that I have created.
	* The fan speed will change the the temperature is rising and stable for 2 seconds.
	* When the temperature is falling, there is a 2°C Hysteresis, so it will change 2°C lower than the table entry.
```
25°C		2,000 RMP
31°C		3,000 RMP
36°C		4,000 RMP
42°C		5,000 RMP
48°C		6,000 RMP
53°C		7,000 RMP
59°C		8,000 RMP
65°C		9,000 RMP
```

# Final  Configuration
## MFR_MODE -Common Register
```
MFR_MODE          	D1	2	0007
		15		0	Do not log
		14		0	Set to clear log.
		13		0	Alert disabled.  
					 If set the host will need to intervene on alert
		12		0	Always 0
		11		0	Soft Reset. Set/Clear/Set within 8ms
		10:8		0	Always 0
		7:6		00	Define Health.  4 options. 
					Green  <10%
					Orange <15%
					Red    >15%
		5:0		000011	ADC 5-2 Disabled, ADC 1 - 0 Enabled
					Enabled is overridden if temp sense is enabled.
					  MFR_TEMP_SENSOR_CONFIG bit 15
```
### MFR_FAULT_RESPONSE - Fans, Temperatures & Volts
### Temperatures
Each Fan, Temperature sensor and volt input had a dedicated MFR_FAULT_RESPONSE register.
```
MFR_FAULT_RESPONSE	D9	1	02
		7		0	Do not log
		6		0	N/A for temperatures, only pages 17-22 (volts)
		5		0	N/A for temperatures, only pages 17-22 (volts)
		4:3		0	Always 0
		2		0	N/A for temperatures, only pages 17-22 (volts)
		1		1	Assert Fault pin during active fault
		0		0	N/A for temperatures, only pages 0-5 (fans)

Voltages
MFR_FAULT_RESPONSE	D9	1	06
		7		0	Do not log
		6		0	No OV log either
		5		0	Fault/Warning on 1 excursion.
		4:3		0	Always 0
		2		1	Enable fault on OV also.
		1		1	Assert Fault pin during active fault
		0		0	N/A for voltages, only pages 0-5 (fans)

Fans
MFR_FAULT_RESPONSE	D9	1	03
		7		0	Do not log
		6		0	N/A for fans, only pages 17-22 (volts)
		5		0	N/A for fans, only pages 17-22 (volts)
		4:3		0	Always 0
		2		0	N/A for fans, only pages 17-22 (volts)
		1		1	Assert Fault pin during active fault
		0		1	Force fans to 100% when Fault pin active
```
### Fans
```
FAN_COMMAND_1           	3B	2	8000		
		15		1	Automatic fan control
		14:0		0	RPM or PWM if not automatic.
		
MFR_FAN_CONFIG          	F1	2	E033	
		15:13	111	25kHz PWM Freq.
					150Hz and most likely lower caused the fan stop
					when accelerating to slow speeds.  (2,000 RMM).
					Most likely the Freq. interfered with the actual
					speed of the fan motor
		12		0	Disable Dual-tach
		11:10	00	2°C Hysteresis.  I decided 4°, 6° or 8° was too much.
					I want the fans on at 25° and as the temperature 
					drops I want them to come back on as close to 25° as
					possible, so this will turn them back on at 23°
		9		0	Ramp to 100% PWM if temp sensor faults.
		8		0	Ramp to 100% PWM if fan fault detected
		7:5		001	Update every 1000ms, 2% per second.
					Updating every 200ms was too fast for the fan, the 
					fans speed did not respond fast enough.
		4		1	Enable Health
		3		0	This is egnored because bit 2, is 0
		2		0	Tach input expects fan RPM.
		1:0		11	Detect 8 revolutions within 2 seconds at fan start.
					If not 8, then 100% PWM.
					
FAN_CONFIG_1_2          	3A	1	D0	
		7		1	Fan Enabled
		6		1	1 = RPM mode.
		5:4		01	Fan has 2 pulses per revolution.
		3:0		0	Always 0


MFR_FAN_FAULT_LIMIT     	F5	2	01F4
		15:0		01F4		500 RPM set a a Fan Fault.
						1000 RPM will be a Fan Warning
							
MFR_FAN_LUT              F2  32  09C4 07D0   0C1C 0BB8   0E10 0FA0   1068 1388   12C0 1770   14B4 1B58   170C   1F40   1964 2328
; Max 9,000 RPM                  25°  2,000  31°  3,000  36°  4,000  42°  5,000  48°  6,000   53° 7,000   59°    8,000  65°  9,000

MFR_FAN_PWM2RPM         	F9	8   0F6E  189C  2134  2260	
;								40%   60%   80%   100%
; 9,000 RPM                      3,950 6,300 8,500 8,800

MFR_FAN_WARN_LIMIT      	F6	2	03E8	
		15:0		03E8		1000 RPM set a a Fan Warning.
						500 RPM will be a Fan Fault

```
### Temperature
```
MFR_TEMP_SENSOR_CONFIG		800F
		15	1	Enabled
		14:10	0	No temp ° offset
		9:6	0	Always 0
		5	0	Not Fan 5
		4	0   Not Fan 4
		3	1   Used to control Fan 3 speed
		2	1   Used to control Fan 2 speed
		1	1   Used to control Fan 1 speed
		0	1   Used to control Fan 0 speed
		
OT_FAULT_LIMIT          	4F	2	1B58
;                                70°
OT_WARN_LIMIT           	51	2	1170
;                                60°

```
### Voltages
```
R1 / (R1+R2) = Divisor
VOUT_SCALE_MONITOR / 32,767 = Divisor
:: VOUT_SCALE_MONITOR = Divisor * 32,767
Full scale input is 1.225v

; Voltage 0 UCD_3V3
; 4.99k / (10k + 4.99k) = 0.332888592
; 10,908 = 0.332888592 * 32,767
;
VOUT_OV_FAULT_LIMIT     	40	2	0E2E	
VOUT_OV_WARN_LIMIT      	42	2	0D89	
VOUT_SCALE_MONITOR      	2A	2	2A9C	
VOUT_UV_FAULT_LIMIT     	44	2	0C3F	
VOUT_UV_WARN_LIMIT      	43	2	0B9A

; Voltage 1 SYS_1V5_mSATA
; 10k / (10k + 10k) = 0.5
; 16,384 = 0.5 * 32,767
;
VOUT_OV_FAULT_LIMIT     	40	2	0672	
VOUT_OV_WARN_LIMIT      	42	2	0627	
VOUT_SCALE_MONITOR      	2A	2	4000	
VOUT_UV_FAULT_LIMIT     	44	2	0591	
VOUT_UV_WARN_LIMIT      	43	2	0546
```




```


For each fan
MFR_FAN_CONFIG          	F1	2	6213
		15:13	011	150Hz frequency
		12	0 	Not DualTach
		11:10   00	2° Hysteresis
		9	0	Ramp to 100% on temp fault
		8	0	Ramp to 100% on fan fault
		7:5	000	1000, 1, 60
		4	1	Health meter enabled
		3	0	Ignored
		2	0	Tach expects RPM
		1:0	11	Eight revolutions
		


FAN_COMMAND_1 			8000
		8000		Ignore, use fan control

FAN_CONFIG_1_2			  D0
		7	1	Fan enabled
		6	1	RPM mode, (Not PWM)
		5:4	01	2 PPRev
		3:0		Always 0

MFR_FAN_LUT
MFR_FAN_CONFIG

MFR_FAN_WARN_LIMIT
MFR_FAN_FAULT_LIMIT

MFR_FAN_PWM2RPM



STATUS_FANS_1_2

MFR_TEMP_SENSOR_CONFIG  	F0	2	8020
		15		1	Sensor Enabled
		14:10	0 	No temp ° offset, 0°C offset
		9:6		0	Always 0
		5		1	Fan 5
		4		0
		3		0
		2		0
		1		0
		0		0
```

# Driver questions/concerns
```
We should connect the eval board to a TSX-100 to evaluate the sysFS files provided.

The following concerns may be invalid, but connecting it to a TSX-100 will most likely provide the answers.
```
### Status_word / Status_byte
```
I don't see these status's in the sysFS
```
### Resetting alarms
```
I don't see means to reset alarms.
```
### Fan health
```
I don't see fan health access
```
